<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EdClub Customer Explorer</title>
    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-hover: #334155;
            --border: #475569;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --accent-hover: #60a5fa;
            --success: #22c55e;
            --enriched: #10b981;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .subtitle {
            color: var(--text-muted);
            font-size: 1rem;
        }
        
        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(16, 185, 129, 0.2);
            color: var(--enriched);
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 1rem;
        }
        
        .live-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--enriched);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .stats-bar {
            display: flex;
            gap: 1.5rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        .stat {
            background: var(--surface);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-value.enriched {
            color: var(--enriched);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            outline: none;
            transition: border-color 0.2s;
        }
        
        input[type="text"]:focus {
            border-color: var(--accent);
        }
        
        input[type="text"]::placeholder {
            color: var(--text-muted);
        }
        
        select {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
        }
        
        .results-info {
            color: var(--text-muted);
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1rem;
        }
        
        .customer-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .customer-card:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
            transform: translateY(-2px);
        }
        
        .customer-card.enriched {
            border-left: 3px solid var(--enriched);
        }
        
        .customer-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
            word-break: break-word;
            color: var(--text);
        }
        
        .customer-subdomain {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: monospace;
            margin-bottom: 0.5rem;
        }
        
        .customer-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .customer-link {
            display: inline-block;
            margin-top: 0.5rem;
            color: var(--accent);
            font-size: 0.875rem;
            text-decoration: none;
        }
        
        .customer-link:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }
        
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-district { background: #1d4ed8; }
        .badge-elementary { background: #059669; }
        .badge-middle { background: #7c3aed; }
        .badge-high { background: #dc2626; }
        .badge-charter { background: #ea580c; }
        .badge-private { background: #0891b2; }
        .badge-other { background: var(--border); }
        
        .enriched-badge {
            background: rgba(16, 185, 129, 0.2);
            color: var(--enriched);
        }
        
        .export-btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .export-btn:hover {
            background: var(--accent-hover);
        }
        
        .refresh-btn {
            padding: 0.75rem 1rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .refresh-btn:hover {
            background: var(--surface-hover);
            border-color: var(--accent);
        }
        
        footer {
            margin-top: 3rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.875rem;
            text-align: center;
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--surface);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--enriched);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                üéπ EdClub Customer Explorer
                <span class="live-badge" id="liveBadge" style="display: none;">ENRICHING LIVE</span>
            </h1>
            <p class="subtitle">TypingClub subdomain customer database with real school names</p>
        </header>
        
        <div class="stats-bar">
            <div class="stat">
                <div class="stat-value" id="totalCount">--</div>
                <div class="stat-label">Total Customers</div>
            </div>
            <div class="stat">
                <div class="stat-value enriched" id="enrichedCount">--</div>
                <div class="stat-label">Names Resolved</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
            <div class="stat">
                <div class="stat-value" id="districtCount">--</div>
                <div class="stat-label">School Districts</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="elementaryCount">--</div>
                <div class="stat-label">Elementary Schools</div>
            </div>
        </div>
        
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search by school name, subdomain, or keyword...">
            <select id="categoryFilter">
                <option value="">All Categories</option>
                <option value="district">Districts</option>
                <option value="elementary">Elementary</option>
                <option value="middle">Middle Schools</option>
                <option value="high">High Schools</option>
                <option value="charter">Charter/Academy</option>
                <option value="private">Private/Religious</option>
                <option value="other">Other</option>
            </select>
            <select id="enrichedFilter">
                <option value="">All Status</option>
                <option value="enriched">‚úì Name Resolved</option>
                <option value="pending">‚è≥ Pending</option>
            </select>
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
            <button class="export-btn" onclick="exportCSV()">üì• Export CSV</button>
        </div>
        
        <div class="results-info" id="resultsInfo">Loading...</div>
        
        <div class="customer-grid" id="customerGrid">
            <div class="loading">Loading customer data...</div>
        </div>
        
        <footer>
            <p>Data source: RapidDNS subdomain enumeration + login page scraping</p>
            <p>Auto-refreshes every 30 seconds during enrichment</p>
        </footer>
    </div>
    
    <script>
        let allCustomers = [];
        let enrichedData = {};
        let filteredData = [];
        let autoRefreshInterval = null;
        
        function categorize(name) {
            const lower = (name || '').toLowerCase();
            if (lower.includes('usd') || lower.includes('isd') || lower.includes('district') || lower.includes('csd') || lower.includes('unified') || lower.includes('county school')) {
                return 'district';
            }
            if (lower.includes('elementary') || lower.includes('-el') || lower.includes('elem') || lower.includes('primary')) {
                return 'elementary';
            }
            if (lower.includes('middle') || lower.includes('junior') || lower.includes('-ms') || lower.includes('-jh') || lower.includes('intermediate')) {
                return 'middle';
            }
            if (lower.includes('high') || lower.includes('-hs') || lower.includes('senior') || lower.includes('secondary')) {
                return 'high';
            }
            if (lower.includes('charter') || lower.includes('academy') || lower.includes('magnet')) {
                return 'charter';
            }
            if (lower.includes('catholic') || lower.includes('christian') || lower.includes('lutheran') || 
                lower.includes('st.') || lower.includes('saint') || lower.includes('holy') || lower.includes('sacred') ||
                lower.includes('jewish') || lower.includes('day school') || lower.includes('parish')) {
                return 'private';
            }
            return 'other';
        }
        
        function formatName(subdomain) {
            return subdomain
                .replace(/-/g, ' ')
                .replace(/\d+$/, '')
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ')
                .trim();
        }
        
        function getBadgeClass(category) {
            return `badge-${category}`;
        }
        
        async function loadEnrichedData() {
            try {
                const response = await fetch('enriched-data.json?t=' + Date.now());
                if (response.ok) {
                    const data = await response.json();
                    enrichedData = {};
                    data.forEach(item => {
                        if (item.subdomain) {
                            enrichedData[item.subdomain] = item;
                        }
                    });
                    return true;
                }
            } catch (e) {
                console.log('No enriched data yet');
            }
            return false;
        }
        
        async function loadBaseData() {
            try {
                const response = await fetch('data.js?t=' + Date.now());
                const text = await response.text();
                // Parse the JS file to extract the array
                const match = text.match(/const customers = \[([\s\S]*)\];/);
                if (match) {
                    allCustomers = eval('[' + match[1] + ']');
                }
            } catch (e) {
                console.error('Failed to load base data', e);
            }
        }
        
        async function loadData() {
            await loadBaseData();
            const hasEnriched = await loadEnrichedData();
            
            // Merge data
            allCustomers = allCustomers.map(c => {
                const enriched = enrichedData[c.subdomain];
                return {
                    ...c,
                    schoolName: enriched?.schoolName || null,
                    enriched: !!enriched?.schoolName,
                    state: enriched?.state || null,
                    city: enriched?.city || null
                };
            });
            
            updateStats();
            filterData();
            
            // Show live badge if enrichment in progress
            const enrichedCount = Object.keys(enrichedData).length;
            const liveBadge = document.getElementById('liveBadge');
            if (enrichedCount > 0 && enrichedCount < allCustomers.length) {
                liveBadge.style.display = 'inline-flex';
                // Auto-refresh every 30 seconds
                if (!autoRefreshInterval) {
                    autoRefreshInterval = setInterval(loadData, 30000);
                }
            } else if (enrichedCount >= allCustomers.length) {
                liveBadge.style.display = 'none';
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }
        
        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const enrichedFilter = document.getElementById('enrichedFilter').value;
            
            filteredData = allCustomers.filter(c => {
                const displayName = c.schoolName || formatName(c.subdomain);
                const matchesSearch = !search || 
                    c.subdomain.toLowerCase().includes(search) ||
                    displayName.toLowerCase().includes(search) ||
                    (c.schoolName && c.schoolName.toLowerCase().includes(search));
                
                const nameForCategory = c.schoolName || c.subdomain;
                const matchesCategory = !category || categorize(nameForCategory) === category;
                
                const matchesEnriched = !enrichedFilter || 
                    (enrichedFilter === 'enriched' && c.enriched) ||
                    (enrichedFilter === 'pending' && !c.enriched);
                
                return matchesSearch && matchesCategory && matchesEnriched;
            });
            
            render();
        }
        
        function render() {
            const grid = document.getElementById('customerGrid');
            
            document.getElementById('resultsInfo').textContent = 
                `Showing all ${filteredData.length} results`;
            
            if (filteredData.length === 0) {
                grid.innerHTML = '<div class="loading">No matching customers found</div>';
                return;
            }
            
            grid.innerHTML = filteredData.map(c => {
                const displayName = c.schoolName || formatName(c.subdomain);
                const nameForCategory = c.schoolName || c.subdomain;
                const category = categorize(nameForCategory);
                
                return `
                    <div class="customer-card ${c.enriched ? 'enriched' : ''}" onclick="window.open('https://${c.subdomain}.typingclub.com', '_blank')">
                        <div class="customer-name">${displayName}</div>
                        <div class="customer-subdomain">${c.subdomain}.typingclub.com</div>
                        <div class="customer-meta">
                            <span class="category-badge ${getBadgeClass(category)}">${category}</span>
                            ${c.enriched ? '<span class="category-badge enriched-badge">‚úì Verified</span>' : ''}
                            ${c.state ? `<span class="category-badge">${c.state}</span>` : ''}
                        </div>
                        <a class="customer-link" href="https://${c.subdomain}.typingclub.com" target="_blank" onclick="event.stopPropagation()">Visit Portal ‚Üí</a>
                    </div>
                `;
            }).join('');
        }
        
        function updateStats() {
            const enrichedCount = allCustomers.filter(c => c.enriched).length;
            const districts = allCustomers.filter(c => categorize(c.schoolName || c.subdomain) === 'district').length;
            const elementary = allCustomers.filter(c => categorize(c.schoolName || c.subdomain) === 'elementary').length;
            
            document.getElementById('totalCount').textContent = allCustomers.length.toLocaleString();
            document.getElementById('enrichedCount').textContent = enrichedCount.toLocaleString();
            document.getElementById('districtCount').textContent = districts.toLocaleString();
            document.getElementById('elementaryCount').textContent = elementary.toLocaleString();
            
            const progress = allCustomers.length > 0 ? (enrichedCount / allCustomers.length * 100) : 0;
            document.getElementById('progressFill').style.width = progress + '%';
        }
        
        function exportCSV() {
            const headers = ['subdomain', 'school_name', 'category', 'verified', 'url'];
            const rows = filteredData.map(c => {
                const displayName = c.schoolName || formatName(c.subdomain);
                return [
                    c.subdomain,
                    displayName,
                    categorize(c.schoolName || c.subdomain),
                    c.enriched ? 'yes' : 'no',
                    `https://${c.subdomain}.typingclub.com`
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.map(cell => `"${(cell || '').replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'edclub-customers.csv';
            a.click();
        }
        
        // Initialize
        document.getElementById('searchInput').addEventListener('input', filterData);
        document.getElementById('categoryFilter').addEventListener('change', filterData);
        document.getElementById('enrichedFilter').addEventListener('change', filterData);
        
        loadData();
    </script>
</body>
</html>
